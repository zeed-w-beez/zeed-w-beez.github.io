<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="collection logs with fluent-bit on kubernetes"/><meta name="keywords" content="autodevops, kubernetes, fluent-bit, Miracle-working" /><meta name="google-site-verification" content="UbNkzWjJwlu0hdjVZnA_NkcGv6boCLQrnZ0hsjzJ7cM" /><link rel="alternate" href="/atom.xml" title="Miracle-working"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="https://blogs.zeed.w.beez.com/2019/10/30/autodevops/collection-logs-with-fluent-bit-on-kubernetes/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109085701-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109085701-1');
</script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":false,"fancybox":false,"pjax":"","latex":false};
</script>

    <title>collection logs with fluent-bit on kubernetes - Miracle-working</title>
  <link rel="alternate" href="/atom.xml" title="Miracle-working" type="application/atom+xml">
</head>

  <body>
    <div class="scrollPercentage"></div><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Miracle-working</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/tags">
        <li class="mobile-menu-item">标签
          </li>
      </a><a href="/categories">
        <li class="mobile-menu-item">分类
          </li>
      </a><a href="/todo">
        <li class="mobile-menu-item">Todo
          </li>
      </a><a href="/about">
        <li class="mobile-menu-item">关于
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Miracle-working</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            标签
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            分类
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/todo">
            Todo
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about">
            关于
            </a>
        </li>
      </ul></nav>
</header>
      
      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">collection logs with fluent-bit on kubernetes
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-10-29
        </span><span class="post-category">
            <a href="/categories/autodevops/">autodevops</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>Kubernetes 方便的帮我们管理和运维程序，但是也带来了一些新的挑战。比如日志问题。用了Kubernetes 之后，就不能方便的登录到服务器上查看stdout日志，查看系统日志，查看程序的输出日志了。</p>
<p>但是 Kubernetes 有提供更系统化，更高效的日志处理方式。这里就 <a href="https://fluentbit.io/" target="_blank" rel="noopener">fluent-bit</a> 做一下记录。</p>
<p><img src="/images/flb_002.png" alt="fluent-bit"></p>
<a id="more"></a>

<h2 id="Fluentd-amp-Fluent-Bit"><a href="#Fluentd-amp-Fluent-Bit" class="headerlink" title="Fluentd &amp; Fluent Bit"></a>Fluentd &amp; Fluent Bit</h2><p>二者都是同一家公司的两个产品，后者更适合向“云”环境。</p>
<ul>
<li>Fluentd is a log collector, processor, and aggregator.</li>
<li>Fluent Bit is a log collector and processor (it doesn’t have strong aggregation features like Fluentd).</li>
</ul>
<p><img src="/images/fluentdvsfluentbit.png" alt="fluentd vs fluentbit"></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li>Docker</li>
</ol>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker pull fluent/fluent-bit:1.3</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># run the following (useless) test which makes Fluent Bit measure CPU usage by the container</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">docker run -ti fluent/fluent-bit:1.3 /fluent-bit/bin/fluent-bit -i cpu -o stdout -f 1</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># out put</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">Fluent-Bit v1.3.x</span></pre></td></tr><tr><td class="code"><pre><span class="line">Copyright (C) Treasure Data</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">[2019/10/01 12:29:02] [ info] [engine] started</span></pre></td></tr><tr><td class="code"><pre><span class="line">[0] cpu.0: [1504290543.000487750, &#123;<span class="string">"cpu_p"</span>=&gt;0.750000, <span class="string">"user_p"</span>=&gt;0.250000, <span class="string">"system_p"</span>=&gt;0.500000, <span class="string">"cpu0.p_cpu"</span>=&gt;0.000000, <span class="string">"cpu0.p_user"</span>=&gt;0.000000, <span class="string">"cpu0.p_system"</span>=&gt;0.000000, <span class="string">"cpu1.p_cpu"</span>=&gt;1.000000, <span class="string">"cpu1.p_user"</span>=&gt;0.000000, <span class="string">"cpu1.p_system"</span>=&gt;1.000000, <span class="string">"cpu2.p_cpu"</span>=&gt;1.000000, <span class="string">"cpu2.p_user"</span>=&gt;1.000000, <span class="string">"cpu2.p_system"</span>=&gt;0.000000, <span class="string">"cpu3.p_cpu"</span>=&gt;0.000000, <span class="string">"cpu3.p_user"</span>=&gt;0.000000, <span class="string">"cpu3.p_system"</span>=&gt;0.000000&#125;]</span></pre></td></tr></table></figure>

<ol>
<li>Windows</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># https://fluentbit.io/releases/1.3/td-agent-bit-1.3.2-1.AMD64.zip</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># SHA256 Checksums: 57a75221b6cee25e4a85881f709462702661ab13a97e68b552ecfc1d341184b3</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 检查Hash</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">PS&gt; <span class="built_in">Get-FileHash</span> td-agent-bit-<span class="number">1.3</span>.<span class="number">2</span>-<span class="number">1</span>.AMD64.exe</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 执行</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">PS&gt; .\bin\fluent-bit.exe -i dummy -o stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># out put</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">PS&gt; .\bin\fluent-bit.exe  -i dummy -o stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">Fluent Bit v1.<span class="number">3.1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">Copyright (C) Treasure <span class="keyword">Data</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">2019</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">04</span>] [ info] [storage] initializing...</span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">2019</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">04</span>] [ info] [storage] in-memory</span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">2019</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">04</span>] [ info] [storage] normal synchronization mode, checksum disabled, max_chunks_up=<span class="number">128</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">2019</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">04</span>] [ info] [engine] started (pid=<span class="number">10324</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">2019</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">04</span>] [ info] [sp] stream processor started</span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">0</span>] dummy.<span class="number">0</span>: [<span class="number">1561684385.443823800</span>, &#123;<span class="string">"message"</span>=&gt;<span class="string">"dummy"</span>&#125;]</span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">1</span>] dummy.<span class="number">0</span>: [<span class="number">1561684386.428399000</span>, &#123;<span class="string">"message"</span>=&gt;<span class="string">"dummy"</span>&#125;]</span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">2</span>] dummy.<span class="number">0</span>: [<span class="number">1561684387.443641900</span>, &#123;<span class="string">"message"</span>=&gt;<span class="string">"dummy"</span>&#125;]</span></pre></td></tr><tr><td class="code"><pre><span class="line">[<span class="number">3</span>] dummy.<span class="number">0</span>: [<span class="number">1561684388.441405800</span>, &#123;<span class="string">"message"</span>=&gt;<span class="string">"dummy"</span>&#125;]</span></pre></td></tr></table></figure>

<ol>
<li>Kubernetes</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://raw.githubusercontent.com/fluent/fluent-bit-kubernetes-logging/master/output/elasticsearch/fluent-bit-configmap.yaml</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit-config</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">labels:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluent-bit</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">data:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="comment"># Configuration files: server, input, filters and output</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="comment"># ======================================================</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[SERVICE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Flush</span>         <span class="number">1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Log_Level</span>     <span class="string">info</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Daemon</span>        <span class="string">off</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Parsers_File</span>  <span class="string">parsers.conf</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Server</span>   <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Listen</span>   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Port</span>     <span class="number">2020</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">@INCLUDE</span> <span class="string">input-kubernetes.conf</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">@INCLUDE</span> <span class="string">filter-kubernetes.conf</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">@INCLUDE</span> <span class="string">output-elasticsearch.conf</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">input-kubernetes.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>              <span class="string">tail</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Tag</span>               <span class="string">kube.*</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Path</span>              <span class="string">/var/log/containers/*.log</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Parser</span>            <span class="string">docker</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">DB</span>                <span class="string">/var/log/flb_kube.db</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Mem_Buf_Limit</span>     <span class="string">5MB</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Skip_Long_Lines</span>   <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Refresh_Interval</span>  <span class="number">10</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">filter-kubernetes.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[FILTER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>                <span class="string">kubernetes</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Match</span>               <span class="string">kube.*</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Kube_URL</span>            <span class="string">https://kubernetes.default.svc:443</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Kube_CA_File</span>        <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Kube_Token_File</span>     <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Kube_Tag_Prefix</span>     <span class="string">kube.var.log.containers.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Merge_Log</span>           <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Merge_Log_Key</span>       <span class="string">log_processed</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">K8S-Logging.Parser</span>  <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">K8S-Logging.Exclude</span> <span class="string">Off</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">output-elasticsearch.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>            <span class="string">es</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Match</span>           <span class="string">*</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Host</span>            <span class="string">$&#123;FLUENT_ELASTICSEARCH_HOST&#125;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Port</span>            <span class="string">$&#123;FLUENT_ELASTICSEARCH_PORT&#125;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Logstash_Format</span> <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Replace_Dots</span>    <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Retry_Limit</span>     <span class="literal">False</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">parsers.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">apache</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>  <span class="string">^(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">[^</span> <span class="string">]*</span> <span class="string">(?&lt;user&gt;[^</span> <span class="string">]*)</span> <span class="string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="string">"(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\"]*?)(?: +\S*)?)?"</span> <span class="string">(?&lt;code&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;size&gt;[^</span> <span class="string">]*)(?:</span> <span class="string">"(?&lt;referer&gt;[^\"]*)"</span> <span class="string">"(?&lt;agent&gt;[^\"]*)"</span><span class="string">)?$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">apache2</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>  <span class="string">^(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">[^</span> <span class="string">]*</span> <span class="string">(?&lt;user&gt;[^</span> <span class="string">]*)</span> <span class="string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="string">"(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^ ]*) +\S*)?"</span> <span class="string">(?&lt;code&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;size&gt;[^</span> <span class="string">]*)(?:</span> <span class="string">"(?&lt;referer&gt;[^\"]*)"</span> <span class="string">"(?&lt;agent&gt;[^\"]*)"</span><span class="string">)?$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">apache_error</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>  <span class="string">^\[[^</span> <span class="string">]*</span> <span class="string">(?&lt;time&gt;[^\]]*)\]</span> <span class="string">\[(?&lt;level&gt;[^\]]*)\](?:</span> <span class="string">\[pid</span> <span class="string">(?&lt;pid&gt;[^\]]*)\])?(</span> <span class="string">\[client</span> <span class="string">(?&lt;client&gt;[^\]]*)\])?</span> <span class="string">(?&lt;message&gt;.*)$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">nginx</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span> <span class="string">^(?&lt;remote&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;user&gt;[^</span> <span class="string">]*)</span> <span class="string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="string">"(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\"]*?)(?: +\S*)?)?"</span> <span class="string">(?&lt;code&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;size&gt;[^</span> <span class="string">]*)(?:</span> <span class="string">"(?&lt;referer&gt;[^\"]*)"</span> <span class="string">"(?&lt;agent&gt;[^\"]*)"</span><span class="string">)?$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">json</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">json</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>        <span class="string">docker</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span>      <span class="string">json</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span>    <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%Y-%m-%dT%H:%M:%S.%L</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Keep</span>   <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>        <span class="string">syslog</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span>      <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>       <span class="string">^\&lt;(?&lt;pri&gt;[0-9]+)\&gt;(?&lt;time&gt;[^</span> <span class="string">]*</span> <span class="string">&#123;1,2&#125;[^</span> <span class="string">]*</span> <span class="string">[^</span> <span class="string">]*)</span> <span class="string">(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;ident&gt;[a-zA-Z0-9_\/\.\-]*)(?:\[(?&lt;pid&gt;[0-9]+)\])?(?:[^\:]*\:)?</span> <span class="string">*(?&lt;message&gt;.*)$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span>    <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%b</span> <span class="string">%d</span> <span class="string">%H:%M:%S</span></span></pre></td></tr></table></figure>

<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><h3 id="Default-Config"><a href="#Default-Config" class="headerlink" title="Default Config"></a>Default Config</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[SERVICE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Flush</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># =====</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Set an interval of seconds before to flush records to a destination</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Flush        5</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Daemon</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># ======</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Instruct Fluent Bit to run in foreground or background mode.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Daemon       Off</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Log_Level</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># =========</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Set the verbosity level of the service, values can be:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment">#</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># - error</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># - warning</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># - info</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># - debug</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># - trace</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment">#</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># By default 'info' is set, that means it includes 'error' and 'warning'.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Log_Level    info</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Parsers_File</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># ============</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Specify an optional 'Parsers' configuration file</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Parsers_File parsers.conf</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Plugins_File plugins.conf</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># HTTP Server</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># ===========</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Enable/Disable the built-in HTTP Server for metrics</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    HTTP_Server  Off</span></pre></td></tr><tr><td class="code"><pre><span class="line">    HTTP_Listen  0.0.0.0</span></pre></td></tr><tr><td class="code"><pre><span class="line">    HTTP_Port    2020</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag  cpu.local</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Interval Sec</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># ====</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># Read interval (sec) Default: 1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Interval_Sec 1</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name  stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match *</span></pre></td></tr></table></figure>

<h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><p>Section 不能为空；4空格缩进；必须换行；</p>
<h4 id="配置文件支持拆分和引用"><a href="#配置文件支持拆分和引用" class="headerlink" title="配置文件支持拆分和引用"></a>配置文件支持拆分和引用</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">@INCLUDE somefile.conf</span></pre></td></tr><tr><td class="code"><pre><span class="line">@INCLUDE input_*.conf</span></pre></td></tr></table></figure>

<ul>
<li><strong>Note</strong> that despites the order of inclusion, Fluent Bit will ALWAYS respect the following order:</li>
</ul>
<ol>
<li>Service</li>
<li>Inputs</li>
<li>Filters</li>
<li>Outputs</li>
</ol>
<h4 id="支持环境变量和自定义变量"><a href="#支持环境变量和自定义变量" class="headerlink" title="支持环境变量和自定义变量"></a>支持环境变量和自定义变量</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export MY_OUTPUT=stdout</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">@SET my_input=cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line">@SET my_output=stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[SERVICE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name  $&#123;MY_OUTPUT&#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match *</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Flush 1</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name $&#123;my_input&#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name $&#123;my_output&#125;</span></pre></td></tr></table></figure>

<h3 id="Buffering-Storage"><a href="#Buffering-Storage" class="headerlink" title="Buffering / Storage"></a>Buffering / Storage</h3><ul>
<li>that configuration configure an optional buffering mechanism where it root for data is /var/log/flb-storage/, it will use normal synchronization mode, without checksum and up to a maximum of 5MB of memory when processing backlog data.</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[SERVICE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    flush                     1</span></pre></td></tr><tr><td class="code"><pre><span class="line">    log_Level                 info</span></pre></td></tr><tr><td class="code"><pre><span class="line">    storage.path              /var/log/flb-storage/</span></pre></td></tr><tr><td class="code"><pre><span class="line">    storage.sync              normal</span></pre></td></tr><tr><td class="code"><pre><span class="line">    storage.checksum          off</span></pre></td></tr><tr><td class="code"><pre><span class="line">    storage.backlog.mem_limit 5M</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># Specify the buffering mechanism to use. It can be memory or filesystem.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name          cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line">    storage.type  filesystem</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name          mem</span></pre></td></tr><tr><td class="code"><pre><span class="line">    storage.type  memory</span></pre></td></tr></table></figure>

<h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h3><p>By default configured plugins on runtime get an internal name in the format plugin_name.ID. For monitoring purposes this can be confusing if many plugins of the same type were configured. To make a distinction each configured input or output section can get an alias that will be used as the parent name for the metric.</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[SERVICE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    HTTP_Server  On</span></pre></td></tr><tr><td class="code"><pre><span class="line">    HTTP_Listen  0.0.0.0</span></pre></td></tr><tr><td class="code"><pre><span class="line">    HTTP_PORT    2020</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name  cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Alias server1_cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name  stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Alias raw_output</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match *</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># /api/v1/metrics/prometheus</span></span></pre></td></tr></table></figure>

<h3 id="Upstream-Servers"><a href="#Upstream-Servers" class="headerlink" title="Upstream Servers"></a>Upstream Servers</h3><ul>
<li>It’s common that Fluent Bit output plugins aims to connect to external services to deliver the logs over the network, this is the case of HTTP, Elasticsearch and Forward within others. Being able to connect to one node (host) is normal and enough for more of the use cases, but there are other scenarios where balancing across different nodes is required. The Upstream feature provides such capability.</li>
<li>An Upstream defines a set of nodes that will be targeted by an output plugin, by the nature of the implementation an output plugin must support the Upstream feature. The following plugin(s) have Upstream support: <a href="https://docs.fluentbit.io/manual/output/forward" target="_blank" rel="noopener">Forward</a>.</li>
<li>The current balancing mode implemented is round-robin.</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># The following example defines an Upstream called forward-balancing which aims to be used by Forward output plugin, it register three Nodes:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[UPSTREAM]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name       forward-balancing</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># node-1: connects to 127.0.0.1:43000</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[NODE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name       node-1</span></pre></td></tr><tr><td class="code"><pre><span class="line">    host       127.0.0.1</span></pre></td></tr><tr><td class="code"><pre><span class="line">    port       43000</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># node-2: connects to 127.0.0.1:44000</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[NODE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name       node-2</span></pre></td></tr><tr><td class="code"><pre><span class="line">    host       127.0.0.1</span></pre></td></tr><tr><td class="code"><pre><span class="line">    port       44000</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># node-3: connects to 127.0.0.1:45000 using TLS without verification. It also defines a specific configuration option required by Forward output called shared_key.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[NODE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name       node-3</span></pre></td></tr><tr><td class="code"><pre><span class="line">    host       127.0.0.1</span></pre></td></tr><tr><td class="code"><pre><span class="line">    port       45000</span></pre></td></tr><tr><td class="code"><pre><span class="line">    tls        on</span></pre></td></tr><tr><td class="code"><pre><span class="line">    tls.verify off</span></pre></td></tr><tr><td class="code"><pre><span class="line">    shared_key secret</span></pre></td></tr></table></figure>

<h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p>Fluent Bit has an Engine that helps to coordinate the data ingestion from input plugins and call the Scheduler to decide when is time to flush the data through one or multiple output plugins. The Scheduler flush new data every a fixed time of seconds and Schedule retries when asked.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># The following example configure two outputs where the HTTP plugin have an unlimited number of retries and the Elasticsearch plugin have a limit of 5 times:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name        http</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Host        192.168.5.6</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Port        8080</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Retry_Limit False</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name            es</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Host            192.168.5.20</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Port            9200</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Logstash_Format On</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Retry_Limit     5</span></pre></td></tr></table></figure>

<h2 id="Input-Plugins-Tail"><a href="#Input-Plugins-Tail" class="headerlink" title="Input Plugins Tail"></a>Input Plugins Tail</h2><p>The plugin reads every matched file in the Path pattern and for every new line found (separated by a \n), it generates a new record. Optionally a database file can be used so the plugin can have a history of tracked files and a state of offsets, this is very useful to resume a state if the service is restarted.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name        tail</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Path        /var/log/syslog</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name   stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match  *</span></pre></td></tr></table></figure>

<h2 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h2><p>By default, Fluent Bit provides a set of pre-configured parsers that can be used for different use cases such as logs from: <code>Apache</code>, <code>Nginx</code>, <code>Docker</code>, <code>Syslog rfc5424</code>, <code>Syslog rfc3164</code>.</p>
<p>All parsers <strong>must</strong> be defined in a parsers.conf file, <strong>not</strong> in the Fluent Bit global configuration file. The parsers file expose all parsers available that can be used by the Input plugins that are aware of this feature. A parsers file can have multiple entries like this:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name        docker</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Format      json</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Time_Key    time</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Time_Format %Y-%m-%dT%H:%M:%S.%L</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Time_Keep   On</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name        syslog-rfc5424</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Format      regex</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Regex       ^\&lt;(?&lt;pri&gt;[0-9]&#123;1,5&#125;)\&gt;1 (?&lt;time&gt;[^ ]+) (?&lt;host&gt;[^ ]+) (?&lt;ident&gt;[^ ]+) (?&lt;pid&gt;[-0-9]+) (?&lt;msgid&gt;[^ ]+) (?&lt;extradata&gt;(\[(.*)\]|-)) (?&lt;message&gt;.+)$</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Time_Key    time</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Time_Format %Y-%m-%dT%H:%M:%S.%L</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Time_Keep   On</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Types pid:integer</span></pre></td></tr></table></figure>

<h2 id="Filter-in-Kubernetes"><a href="#Filter-in-Kubernetes" class="headerlink" title="Filter in Kubernetes"></a>Filter in Kubernetes</h2><h3 id="Kubernetes-Annotations"><a href="#Kubernetes-Annotations" class="headerlink" title="Kubernetes Annotations"></a>Kubernetes Annotations</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">name:</span> <span class="string">apache-logs</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">labels:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app:</span> <span class="string">apache-logs</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">annotations:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># define parser</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">fluentbit.io/parser:</span> <span class="string">apache</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># exclude</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">fluentbit.io/exclude:</span> <span class="string">"true"</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">containers:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">image:</span> <span class="string">edsiper/apache_logs</span></span></pre></td></tr></table></figure>

<h3 id="Workflow-of-Tail-Kubernetes-Filter"><a href="#Workflow-of-Tail-Kubernetes-Filter" class="headerlink" title="Workflow of Tail + Kubernetes Filter"></a>Workflow of Tail + Kubernetes Filter</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name    tail</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag     kube.*</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Path    /var/log/containers/*.log</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Parser  docker</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[FILTER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name             kubernetes</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match            kube.*</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Kube_URL         https://kubernetes.default.svc:443</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Kube_CA_File     /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Kube_Token_File  /var/run/secrets/kubernetes.io/serviceaccount/token</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Kube_Tag_Prefix  kube.var.log.containers.</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Merge_Log        On</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Merge_Log_Key    log_processed</span></pre></td></tr></table></figure>

<h3 id="Helm-Charts-and-Yaml"><a href="#Helm-Charts-and-Yaml" class="headerlink" title="Helm Charts and Yaml"></a>Helm Charts and Yaml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">data:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[SERVICE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Flush</span>           <span class="number">2</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Daemon</span>          <span class="string">off</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Log_Level</span>       <span class="string">info</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Parsers_File</span>    <span class="string">parsers.conf</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Plugins_File</span>    <span class="string">plugins.conf</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Server</span>     <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Listen</span>     <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Port</span>       <span class="number">2020</span></span></pre></td></tr></table></figure>

<h2 id="Modify-Filter"><a href="#Modify-Filter" class="headerlink" title="Modify Filter"></a>Modify Filter</h2><ul>
<li>The Modify Filter plugin allows you to change records using rules and conditions.</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name mem</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag  mem.local</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name  stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match *</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[FILTER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name modify</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match *</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Add Service1 SOMEVALUE</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Add Service3 SOMEVALUE3</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Add Mem.total2 TOTALMEM2</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Rename Mem.free MEMFREE</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Rename Mem.used MEMUSED</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Rename Swap.total SWAPTOTAL</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Add Mem.total TOTALMEM</span></pre></td></tr></table></figure>

<ul>
<li>Conditionally Add and Remove</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name mem</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag  mem.local</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Interval_Sec 1</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[FILTER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name    modify</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match   mem.*</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Condition Key_Does_Not_Exist cpustats</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Condition Key_Exists Mem.used</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Set cpustats UNKNOWN</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[FILTER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name    modify</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match   mem.*</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Condition Key_Value_Does_Not_Equal cpustats KNOWN</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Add sourcetype memstats</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[FILTER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name    modify</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match   mem.*</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Condition Key_Value_Equals cpustats UNKNOWN</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Remove_wildcard Mem</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Remove_wildcard Swap</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Add cpustats_more STILL_UNKNOWN</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name           stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match          *</span></pre></td></tr></table></figure>

<h3 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h3><p>There are two important concepts in Routing: <code>Tag</code>, <code>Match</code></p>
<ul>
<li>When the data is generated by the input plugins, it comes with a Tag (most of the time the Tag is configured manually), the Tag is a human-readable indicator that helps to identify the data source.</li>
<li>In order to define where the data should be routed, a Match rule must be specified in the output configuration.</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Consider the following configuration example that aims to deliver CPU metrics to an Elasticsearch database and Memory metrics to the standard output interface:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag  my_cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name mem</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag  my_mem</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name   es</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match  my_cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name   stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match  my_mem</span></pre></td></tr></table></figure>

<ul>
<li><p>Routing works automatically reading the Input Tags and the Output Match rules. If some data has a Tag that doesn’t match upon routing time, the data is <code>deleted</code>.</p>
</li>
<li><p>Routing with Wildcard: Routing is flexible enough to support wildcard in the Match pattern. The below example defines a common destination for both sources of data:</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># The match rule is set to my_* which means it will match any Tag that starts with my_.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag  my_cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name mem</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag  my_mem</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name   stdout</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match  my_*</span></pre></td></tr></table></figure>

<h2 id="Output-Plugins"><a href="#Output-Plugins" class="headerlink" title="Output Plugins"></a>Output Plugins</h2><h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name  cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Tag   cpu</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="section">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Name  es</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Match *</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Host  192.168.2.3</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Port  9200</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Index my_index</span></pre></td></tr><tr><td class="code"><pre><span class="line">    Type  my_type</span></pre></td></tr></table></figure>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>下面是一个 sidecar 模式部署的 flb 收集 nginx 日志的例子和 Yaml 文件。</p>
<p>大致的流程示意图：<img src="/images/flb-sidecar.png" alt="flb-sidecar"></p>
<ul>
<li>注意：下面挂载的共享日志目录是 /app/log/ ，而非默认的 /var/log/nginx/ 目录。</li>
</ul>
<blockquote>
<p>因为默认的 nginx 镜像会把 access.log -&gt; stdout，所以不能直接挂载。这里测试的时候，是直接进入 nginx 的容器，把 access.log 手动 copy 到 /app/log/ 目录下，再观察 fluent-bit 的 Container 会不会把 access.log 的内容输出到 stdout 上。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># Source: default/templates/configmap.yaml</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">name:</span> <span class="string">zeed-flb-default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">labels:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">default-0.1.0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">zeed-flb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">"1.0"</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Tiller</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">data:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="comment"># Configuration files: server, input, filters and output</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="comment"># ======================================================</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[SERVICE]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Flush</span>         <span class="number">5</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Log_Level</span>     <span class="string">info</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Daemon</span>        <span class="string">off</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Parsers_File</span>  <span class="string">parsers.conf</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Server</span>   <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Listen</span>   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">HTTP_Port</span>     <span class="number">2020</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span> <span class="string">dummy</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Tag</span>  <span class="string">dummy.log</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Tag</span>  <span class="string">nginx.access</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Parser</span> <span class="string">nginx</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Path</span> <span class="string">/app/log/nginx-access.log</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[INPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Tag</span>  <span class="string">nginx.error</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Parser</span> <span class="string">nginx</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Path</span> <span class="string">/app/log/nginx-error.log</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>  <span class="string">stdout</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Match</span> <span class="string">*</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[OUTPUT]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>  <span class="string">es</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Match</span> <span class="string">es.nginx.*</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Host</span>  <span class="number">192.168</span><span class="number">.2</span><span class="number">.3</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Port</span>  <span class="number">9200</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Index</span> <span class="string">my_index</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Type</span>  <span class="string">my_type</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">parsers.conf:</span> <span class="string">|</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">apache</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>  <span class="string">^(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">[^</span> <span class="string">]*</span> <span class="string">(?&lt;user&gt;[^</span> <span class="string">]*)</span> <span class="string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="string">"(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\"]*?)(?: +\S*)?)?"</span> <span class="string">(?&lt;code&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;size&gt;[^</span> <span class="string">]*)(?:</span> <span class="string">"(?&lt;referer&gt;[^\"]*)"</span> <span class="string">"(?&lt;agent&gt;[^\"]*)"</span><span class="string">)?$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">apache2</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>  <span class="string">^(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">[^</span> <span class="string">]*</span> <span class="string">(?&lt;user&gt;[^</span> <span class="string">]*)</span> <span class="string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="string">"(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^ ]*) +\S*)?"</span> <span class="string">(?&lt;code&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;size&gt;[^</span> <span class="string">]*)(?:</span> <span class="string">"(?&lt;referer&gt;[^\"]*)"</span> <span class="string">"(?&lt;agent&gt;[^\"]*)"</span><span class="string">)?$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">apache_error</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>  <span class="string">^\[[^</span> <span class="string">]*</span> <span class="string">(?&lt;time&gt;[^\]]*)\]</span> <span class="string">\[(?&lt;level&gt;[^\]]*)\](?:</span> <span class="string">\[pid</span> <span class="string">(?&lt;pid&gt;[^\]]*)\])?(</span> <span class="string">\[client</span> <span class="string">(?&lt;client&gt;[^\]]*)\])?</span> <span class="string">(?&lt;message&gt;.*)$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">nginx</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span> <span class="string">^(?&lt;remote&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;user&gt;[^</span> <span class="string">]*)</span> <span class="string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="string">"(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\"]*?)(?: +\S*)?)?"</span> <span class="string">(?&lt;code&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;size&gt;[^</span> <span class="string">]*)(?:</span> <span class="string">"(?&lt;referer&gt;[^\"]*)"</span> <span class="string">"(?&lt;agent&gt;[^\"]*)"</span><span class="string">)?$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>   <span class="string">json</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span> <span class="string">json</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>        <span class="string">docker</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span>      <span class="string">json</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span>    <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%Y-%m-%dT%H:%M:%S.%L</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Keep</span>   <span class="string">On</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">[PARSER]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Name</span>        <span class="string">syslog</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Format</span>      <span class="string">regex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Regex</span>       <span class="string">^\&lt;(?&lt;pri&gt;[0-9]+)\&gt;(?&lt;time&gt;[^</span> <span class="string">]*</span> <span class="string">&#123;1,2&#125;[^</span> <span class="string">]*</span> <span class="string">[^</span> <span class="string">]*)</span> <span class="string">(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;ident&gt;[a-zA-Z0-9_\/\.\-]*)(?:\[(?&lt;pid&gt;[0-9]+)\])?(?:[^\:]*\:)?</span> <span class="string">*(?&lt;message&gt;.*)$</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Key</span>    <span class="string">time</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">Time_Format</span> <span class="string">%b</span> <span class="string">%d</span> <span class="string">%H:%M:%S</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># Source: default/templates/service.yaml</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">name:</span> <span class="string">zeed-flb-default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">labels:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">default-0.1.0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">zeed-flb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">"1.0"</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Tiller</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">ports:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">selector:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">zeed-flb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># Source: default/templates/deployment.yaml</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">name:</span> <span class="string">zeed-flb-default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">labels:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">default-0.1.0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">zeed-flb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">"1.0"</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Tiller</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">selector:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">matchLabels:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">app.kubernetes.io/instance:</span> <span class="string">zeed-flb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">template:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">metadata:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">labels:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> <span class="string">zeed-flb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">spec:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">containers:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">image:</span> <span class="string">"nginx:stable"</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">ports:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">livenessProbe:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="attr">httpGet:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">readinessProbe:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="attr">httpGet:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">port:</span> <span class="string">http</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">resources:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="string">&#123;&#125;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">volumeMounts:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log-volume</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app/log/</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-fluentbit</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">image:</span> <span class="string">"fluent/fluent-bit:1.3"</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">ports:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">containerPort:</span> <span class="number">2020</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">volumeMounts:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">mountPath:</span> <span class="string">/fluent-bit/etc/</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log-volume</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app/log/</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">volumes:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log-volume</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">configMap:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">          <span class="attr">name:</span> <span class="string">zeed-flb-default</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># Source: default/templates/ingress.yaml</span></span></pre></td></tr></table></figure>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://blogs.zeed.w.beez.com">zeed-w-beez</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://blogs.zeed.w.beez.com/2019/10/30/autodevops/collection-logs-with-fluent-bit-on-kubernetes/">https://blogs.zeed.w.beez.com/2019/10/30/autodevops/collection-logs-with-fluent-bit-on-kubernetes/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/autodevops/">autodevops</a>
            <a href="/tags/kubernetes/">kubernetes</a>
            <a href="/tags/fluent-bit/">fluent-bit</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2019/11/23/mp/%E5%86%99%E4%B8%AA%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">写个微信小程序</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2019/10/29/autodevops/install-prometheus-with-helm/">
        <span class="next-text nav-default">install-prometheus-with-helm</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:zeed.w.zhao@gmail.com" target="_blank" rel="noopener" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/zeed-w-beez" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>
  <span class="division">|</span>
  <span class="hosting-info">
    由 <a class="netlify-link" href="https://www.netlify.com" target="_blank" rel="noopener">netlify</a> 自动托管
  </span>

  <span class="copyright-year">
    <span>&copy;2015 - 2019</span>

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>

    <span class="author">zeed-w-beez</span>
  </span>

  <span id="beian">
  </span>

</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://blogs.zeed.w.beez.com/2019/10/30/autodevops/collection-logs-with-fluent-bit-on-kubernetes/';
        this.page.identifier = '2019/10/30/autodevops/collection-logs-with-fluent-bit-on-kubernetes/';
        this.page.title = 'collection logs with fluent-bit on kubernetes';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//zeed-w-beez.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
